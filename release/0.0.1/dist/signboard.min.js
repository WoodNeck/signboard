/*
Copyright (c) 2019 WoodNeck
name: signboard
license: MIT
author: WoodNeck
repository: git+https://github.com/WoodNeck/signboard.js.git
version: 0.0.1
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Signboard=t()}(this,function(){"use strict";var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function e(e,a,u,s){return new(u=u||Promise)(function(i,t){function n(e){try{o(s.next(e))}catch(e){t(e)}}function r(e){try{o(s.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?i(e.value):((t=e.value)instanceof u?t:new u(function(e){e(t)})).then(n,r)}o((s=s.apply(e,a||[])).next())})}function r(i,n){var r,o,a,u={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,o&&(a=2&t[0]?o.return:t[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,t[1])).done)return a;switch(o=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,o=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(a=0<(a=u.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){u.label=t[1];break}if(6===t[0]&&u.label<a[1]){u.label=a[1],a=t;break}if(a&&u.label<a[2]){u.label=a[2],u.ops.push(t);break}a[2]&&u.ops.pop(),u.trys.pop();continue}t=n.call(i,u)}catch(e){t=[6,e],o=0}finally{r=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}var n,t,o,a=(n=Error,i(t=s,o=n),t.prototype=null===o?Object.create(o):(u.prototype=o.prototype,new u),s);function u(){this.constructor=t}function s(e,t){var i=n.call(this,"(signboard.js) "+e)||this;return i.message=e,i.code=t,Object.setPrototypeOf(i,s.prototype),i.name="SignBoardError",i}var c=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),f=new Float32Array([0,1,1,1,0,0,0,0,1,1,1,0]),l={WRONG_TYPE:0,ELEMENT_NOT_FOUND:1,ELEMENT_NOT_CANVAS:2,WEBGL_NOT_SUPPORTED:3,FAILED_COMPILE_SHADER:4,FAILED_COMPILE_PROGRAM:5,FAILED_TO_LOAD_IMAGE:6},_=function(e,t){return typeof e+" is not a "+t.map(function(e){return'"'+e+'"'}).join(" or ")+"."},d=function(e){return'Element with selector "'+e+'" not found.'},h=function(e){return"Given element <"+e.tagName+"> is not a canvas."},m=function(e){return'WebGL context creation failed with the following error - "'+e+'"'},E=function(e){return'Failed compiling shader - "'+e+'"'},T=function(e){return'Failed compiling WebGL program - "'+e+'"'},b=function(e){return'Failed to load image with src - "'+e+'"'},g="webglcontextcreationerror",p="load",v="error",R="resize",A="loadeddata";function S(e){var t=function(e){var t=null;if("string"==typeof e){var i=document.querySelector(e);if(!i)throw new a(d(e),l.ELEMENT_NOT_FOUND);t=i}else e&&e.nodeType===Node.ELEMENT_NODE&&(t=e);return t}(e);if(!t)throw new a(_(e,["HTMLElement","string"]),l.WRONG_TYPE);if(!/^canvas$/i.test(t.tagName))throw new a(h(t),l.ELEMENT_NOT_CANVAS);return t}function P(e){function t(e){n=e.statusMessage||"Unknown Error"}var i,n="";if(e.addEventListener(g,t),i=e.getContext("webgl",{}),e.removeEventListener(g,t),!i)throw new a(m(n),l.WEBGL_NOT_SUPPORTED);return e.addEventListener("webglcontextlost",function(e){console.log("contextlost"),e.preventDefault()},!1),i}function y(i){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];return e.forEach(function(t){Object.keys(t).forEach(function(e){i[e]=t[e]})}),i}var x=(B=L.prototype,Object.defineProperty(B,"canvas",{get:function(){return this._canvas},enumerable:!1,configurable:!0}),Object.defineProperty(B,"gl",{get:function(){return this._gl},enumerable:!1,configurable:!0}),Object.defineProperty(B,"frameRate",{get:function(){return this._frameRate},set:function(e){this._frameRate=e},enumerable:!1,configurable:!0}),Object.defineProperty(B,"tileSize",{get:function(){return this._tileSize},set:function(e){this._tileSize=e,this._updateUniforms(),this.render()},enumerable:!1,configurable:!0}),Object.defineProperty(B,"emission",{get:function(){return this._emission},set:function(e){this._emission=e,this._updateUniforms(),this.render()},enumerable:!1,configurable:!0}),Object.defineProperty(B,"bulbSize",{get:function(){return this._bulbSize},set:function(e){this._bulbSize=e,this._updateUniforms(),this.render()},enumerable:!1,configurable:!0}),B.destroy=function(){this.stop(),this._texture=null,this._gl.deleteProgram(this._program)},B.init=function(){var e=this._gl,t=this._createWebGLProgram();this._program=t,e.useProgram(t),this._bindAttributes(t),this._bindUniforms(t),this._updateUniforms()},B.setTexture=function(e){e.init(this._gl),this._texture=e},B.resize=function(){var e=this._canvas;e.width=e.clientWidth,e.height=e.clientHeight,this._updateUniforms()},B.start=function(){this._animationID=requestAnimationFrame(this._onAnimationFrame)},B.stop=function(){cancelAnimationFrame(this._animationID),this._animationID=-1,this._lastRenderTime=-1},B.render=function(){var e=this._gl;this._texture.upload(this._gl),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.TRIANGLES,0,6),e.bindTexture(e.TEXTURE_2D,null)},B._compileShader=function(e,t){var i=this._gl,t=i.createShader(t);if(i.shaderSource(t,e),i.compileShader(t),!i.getShaderParameter(t,i.COMPILE_STATUS))throw new a(E(i.getShaderInfoLog(t)),l.FAILED_COMPILE_SHADER);return t},B._createWebGLProgram=function(){var e=this._gl,t=e.createProgram(),i=this._compileShader("#define GLSLIFY 1\nattribute vec4 aPosition;attribute vec2 aTexCoord;varying vec2 vTexCoord;void main(){gl_Position=aPosition;vTexCoord=aTexCoord;}",e.VERTEX_SHADER),n=this._compileShader("precision highp float;\n#define GLSLIFY 1\nvarying vec2 vTexCoord;uniform float uInvTileSize;uniform vec2 uResolution;uniform float uEmission;uniform float uBulbSize;uniform sampler2D uTexture;float sstep(float edge0,float edge1,float x){x=clamp((x-edge0)/(edge1-edge0),0.0,1.0);return x*x*(3.0-2.0*x);}void main(){vec2 tilesPerSide=floor(uResolution*uInvTileSize);vec2 invTilesPerSide=1.0/tilesPerSide;vec2 tileCenter=floor(vTexCoord*tilesPerSide)*invTilesPerSide+invTilesPerSide*0.5;vec2 diffToCenter=vTexCoord-tileCenter;vec2 distToCenter=diffToCenter*diffToCenter*4.0*tilesPerSide*tilesPerSide;float dist=distToCenter.x+distToCenter.y;float dissipation=1.0-sstep(0.0,uBulbSize*uBulbSize,dist*dist);gl_FragColor=texture2D(uTexture,tileCenter)*dissipation*uEmission;}",e.FRAGMENT_SHADER);if(e.attachShader(t,i),e.attachShader(t,n),e.linkProgram(t),!e.getProgramParameter(t,e.LINK_STATUS))throw new a(T(e.getProgramInfoLog(t)),l.FAILED_COMPILE_PROGRAM);return t},B._bindAttributes=function(e){var t=this._gl,i=t.getAttribLocation(e,"aPosition"),n=t.getAttribLocation(e,"aTexCoord"),r=t.createBuffer(),e=t.createBuffer();t.enableVertexAttribArray(i),t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,c,t.STATIC_DRAW),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(n),t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,f,t.STATIC_DRAW),t.vertexAttribPointer(n,2,t.FLOAT,!1,0,0)},B._bindUniforms=function(e){var t=this._gl;this._uniforms={uInvTileSize:t.getUniformLocation(e,"uInvTileSize"),uResolution:t.getUniformLocation(e,"uResolution"),uEmission:t.getUniformLocation(e,"uEmission"),uBulbSize:t.getUniformLocation(e,"uBulbSize")}},B._updateUniforms=function(){var e=this._gl,t=this._canvas,i=this._uniforms;this._program&&(e.uniform1f(i.uInvTileSize,1/this._tileSize),e.uniform2f(i.uResolution,t.width,t.height),e.uniform1f(i.uEmission,this._emission),e.uniform1f(i.uBulbSize,this._bulbSize))},L);function L(e,t){var n=this,i=t.frameRate,r=t.tileSize,o=t.emission,t=t.bulbSize;this._onAnimationFrame=function(e){var t=n._lastRenderTime,i=1e3/n._frameRate;(i<=e-t||t<0)&&(n.render(),n._lastRenderTime=t+i),n._animationID=requestAnimationFrame(n._onAnimationFrame)},this._canvas=e,this._gl=P(e),this._program=null,this._texture=null,this._lastRenderTime=-1,this._animationID=-1,this._uniforms={uInvTileSize:null,uResolution:null,uEmission:null,uBulbSize:null},this._frameRate=i,this._tileSize=r,this._emission=o,this._bulbSize=t}var O={IMAGE:"image",VIDEO:"video"},z={__proto__:null,CONTENT_TYPE:O,ERROR_CODE:l},D=((C=I.prototype).init=function(e){this._texture=e.createTexture()},C.upload=function(e){e.bindTexture(e.TEXTURE_2D,this._texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this._image)},I);function I(e){this._image=e,this._texture=null}var w=((B=U.prototype).init=function(e){this._texture=e.createTexture(),this._video.play()},B.upload=function(e){e.bindTexture(e.TEXTURE_2D,this._texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this._video)},U);function U(e){this._video=e,this._texture=null}var F=((C=N.prototype).load=function(){return e(this,void 0,Promise,function(){return r(this,function(e){switch(this._type){case O.IMAGE:return[2,this._loadImage()];case O.VIDEO:return[2,this._loadVideo()]}return[2]})})},C._loadImage=function(){return e(this,void 0,Promise,function(){var i,n;return r(this,function(e){return i=new Image,n=this._src,[2,new Promise(function(e,t){i.addEventListener(p,function(){e(new D(i))}),i.addEventListener(v,function(){t(new a(b(n),l.FAILED_TO_LOAD_IMAGE))}),i.crossOrigin="anonymous",i.src=n})]})})},C._loadVideo=function(){return e(this,void 0,Promise,function(){var i,n;return r(this,function(e){return i=document.createElement("video"),n=this._src,[2,new Promise(function(e,t){i.addEventListener(A,function(){e(new w(i))}),i.addEventListener(v,function(){t(new a(b(n),l.FAILED_TO_LOAD_IMAGE))}),i.loop=!0,i.playsInline=!0,i.crossOrigin="anonymous",i.src=n,i.load()})]})})},N);function N(e,t){this._src=e,this._type=t}var C=(B=G.prototype,Object.defineProperty(B,"renderer",{get:function(){return this._renderer},enumerable:!1,configurable:!0}),Object.defineProperty(B,"src",{get:function(){return this._src},enumerable:!1,configurable:!0}),Object.defineProperty(B,"initialized",{get:function(){return this._initialized},enumerable:!1,configurable:!0}),Object.defineProperty(B,"contentType",{get:function(){return this._contentType},set:function(e){this._contentType=e},enumerable:!1,configurable:!0}),Object.defineProperty(B,"frameRate",{get:function(){return this._renderer.frameRate},set:function(e){this._renderer.frameRate=e},enumerable:!1,configurable:!0}),Object.defineProperty(B,"tileSize",{get:function(){return this._renderer.tileSize},set:function(e){this._renderer.tileSize=e},enumerable:!1,configurable:!0}),Object.defineProperty(B,"autoResize",{get:function(){return this._autoResize},set:function(e){this._updateAutoResize(e)},enumerable:!1,configurable:!0}),B.init=function(){return e(this,void 0,void 0,function(){var t,i;return r(this,function(e){switch(e.label){case 0:return t=this._renderer,[4,new F(this._src,this._contentType).load()];case 1:return i=e.sent(),t.resize(),t.init(),t.setTexture(i),this._contentType===O.VIDEO?t.start():t.render(),this._autoResize&&(this._autoResize=!1,this._updateAutoResize(!0)),this._initialized=!0,[2]}})})},B.resize=function(){var e=this._renderer;e.resize(),e.render()},B._updateAutoResize=function(e){this._autoResize!==e&&(e?window.addEventListener(R,this.resize):window.removeEventListener(R,this.resize),this._autoResize=e)},G);function G(e,t,i){var n=void 0===i?{}:i,r=n.contentType,o=void 0===r?O.IMAGE:r,a=n.frameRate,u=void 0===a?60:a,i=n.autoResize,r=void 0===i||i,a=n.tileSize,i=void 0===a?8:a,a=n.emission,a=void 0===a?1:a,n=n.bulbSize,n=void 0===n?.7:n;this._renderer=new x(S(e),{frameRate:u,tileSize:i,emission:a,bulbSize:n}),this._src=t,this._initialized=!1,this._contentType=o,this._autoResize=r,this.resize=this.resize.bind(this),this.init()}var B={__proto__:null,ImageTexture:D,VideoTexture:w};return y(C,{__proto__:null,Renderer:x,SignBoardError:a,TextureLoader:F}),y(C,B),y(C,z),C});
//# sourceMappingURL=signboard.min.js.map
